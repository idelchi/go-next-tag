// go-next-tag is a simple command-line application for managing version tagging in a git repository.
// Allows for the automatic calculation of the next tag based on the current repository state and the bump strategy.
package main

import (
	"fmt"
	"log/slog"
	"os"
	"strings"
)

// Global variable for CI stamping.
var version = "unknown - unofficial & generated by unknown"

func main() { //nolint: funlen,cyclop
	cfg, err := parseFlags()
	if err != nil {
		slog.Error("Parsing flags", "error", err)

		os.Exit(1)
	}

	if err := cfg.Validate(); err != nil {
		slog.Error("Validating configuration", "error", err)

		os.Exit(1)
	}

	// Initialize a new GitManager with the provided flags.
	gitManager, err := NewGitManager(cfg.Token)
	if err != nil {
		slog.Error("Initializing GitManager", "error", err)

		os.Exit(1)
	}

	// Configure git with the provided settings.
	if err := gitManager.ConfigureGit(cfg.User.Name, cfg.User.Email); err != nil {
		slog.Error("Configuring Git", "error", err)

		os.Exit(1)
	}

	if cfg.Action.Checkout != "" {
		// Clone the repository if the clone flag is set.
		branch := strings.Split(cfg.Action.Checkout, " ")[0]
		commit := strings.Split(cfg.Action.Checkout, " ")[1]

		if err := gitManager.Checkout(branch, commit); err != nil {
			slog.Error("Checking out branch", "error", err)

			os.Exit(1)
		}
	}

	// Calculate the next tag based on the current repository state and the bump strategy.
	tag, err := gitManager.CalculateNextTag(cfg.Action.Bump)
	if err != nil {
		slog.Error("Calculating next tag", "error", err)

		os.Exit(1)
	}

	var tagString string

	switch cfg.Action.Format {
	case "semver":
		tagString = fmt.Sprintf("%s%s", cfg.Action.Prefix, tag.String())
	case "majorminor":
		tagString = fmt.Sprintf("%s%d.%d", cfg.Action.Prefix, tag.Major(), tag.Minor())
	}

	slog.Info("Next tag", "tag", tagString)

	// If the dry flag is set, exit without pushing the tag.
	if cfg.Dry {
		os.Exit(0)
	}

	// Create the calculated tag.
	if err := gitManager.CreateTag(tagString); err != nil {
		slog.Error("Creating tag", "error", err)

		os.Exit(1)
	}

	slog.Info("Tag created", "tag", tagString)

	// Push the tag to the remote repository.
	if err := gitManager.PushTag(tagString); err != nil {
		slog.Error("Pushing tag", "error", err)

		os.Exit(1)
	}

	slog.Info("Tag pushed successfully", "tag", tagString)
}
